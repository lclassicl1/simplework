<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>업무 도우미</title>
    <!-- SheetJS 스타일링 지원 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <!-- 유틸리티 함수들 -->
    <script src="js/utils.js"></script>
    <!-- 엑셀 관리 모듈 -->
    <script src="js/excel-manager.js"></script>
    <!-- 대리점 설정 데이터 -->
    <script src="js/agencies-config.js"></script>
    <!-- 앱 설정 데이터 (사이트, 상수 등) -->
    <script src="js/app-config.js"></script>
    <!-- 템플릿 설정 데이터 (TELECOM_CONFIG) -->
    <script src="js/templates-config.js"></script>
    <style>
        /* 모델 검색 결과 스타일 */
        .model-result:hover {
            background-color: #f5f5f5;
        }

        /* 검색 결과 스크롤바 스타일 */
        #modelSearchResults::-webkit-scrollbar {
            width: 8px;
        }

        #modelSearchResults::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #modelSearchResults::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #modelSearchResults::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Toast Notification Styles */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            font-size: 14px;
            font-weight: 500;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .layout-container {
            display: flex;
            gap: 20px;
        }

        .input-column {
            flex: 1;
        }

        .output-column {
            flex: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        select, textarea, input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        select {
            background-color: white;
            cursor: pointer;
        }

        textarea {
            resize: vertical;
        }

        .input-textarea {
            min-height: 300px;
        }

        .output-textarea {
            min-height: 300px;
        }
        
        /* 드블랙 신조요청 전용 textarea 스타일 */
        .drblack-request-textarea {
            min-height: 150px;  /* 기존 높이의 절반 */
            height: 150px;      /* 고정 높이 설정 */
            resize: vertical;   /* 세로 크기 조절만 가능하도록 */
        }

        /* 오앤티 신조요청 전용 textarea 스타일 */
        #ontRequestText {
            height: 120px !important;
            min-height: 120px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #convertBtn {
            background-color: #4CAF50;
            color: white;
            flex: 2;
        }

        #convertBtn:hover {
            background-color: #45a049;
        }

        #copyBtn {
            background-color: #2196F3;
            color: white;
            flex: 1;
        }

        #copyBtn:hover {
            background-color: #0b7dda;
        }

        #clearBtn {
            background-color: #f44336;
            color: white;
            flex: 1;
        }

        #clearBtn:hover {
            background-color: #d32f2f;
        }

        #outputText {
            background-color: #f9f9f9;
        }

        .output-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .output-section h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        /* URL 선택박스 스타일 */
        .url-container {
            margin-bottom: 20px;
            width: 50%;
            margin-right: auto;
            margin-left: 0;
        }
        
        .url-select {
            width: auto;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        /* 대리점 메모 팝업 스타일 */
        .info-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }
        
        .info-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        /* 이력 목록 스타일 */
        .history-list {
            margin: 10px 0;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .history-item:hover {
            background-color: #f5f5f5;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .history-name {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .history-phone {
            color: #555;
            flex-grow: 1;
        }
        
        .history-time {
            color: #888;
            font-size: 0.9em;
        }
        
        .history-details {
            margin: 5px 0;
            color: #333;
        }
        
        .history-model {
            display: inline-block;
            margin-right: 10px;
        }
        
        .history-plan {
            color: #2c7be5;
        }
        
        .history-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }
        
        .no-history {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        
        .history-actions {
            text-align: right;
            margin-top: 15px;
        }
        
        .btn-clear-history {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-clear-history:hover {
            background-color: #cc0000;
        }
        
        .popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        
        .popup-title {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .memo-content {
            white-space: pre-line;
            line-height: 1.5;
        }
        
        /* 키-값 테이블 스타일 */
        .key-value-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .key-value-table th {
            background-color: #f5f5f5;
            padding: 6px 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #ddd;
            width: 30%;
            font-size: 12px;
        }
        
        .key-value-table td {
            padding: 5px 8px;
            border: 1px solid #ddd;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .key-value-table td:hover {
            background-color: #f0f8ff;
        }
        
        .key-value-table td::after {
            content: "클릭하여 복사";
            position: absolute;
            right: 8px;
            color: #999;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .key-value-table td:hover::after {
            opacity: 1;
        }
        
        .key-value-table td.copied {
            background-color: #e6ffe6;
        }
        
        .key-value-table td.copied::after {
            content: "복사됨!";
            color: #4CAF50;
            opacity: 1;
            font-size: 10px;
        }
        
        .copy-notice {
            text-align: center;
            margin-bottom: 10px;
            color: #666;
            font-style: italic;
            font-size: 12px;
        }

        @media (max-width: 900px) {
            .layout-container {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }

        /* 기존 스타일 */
        .output-textarea {
            width: 100%;
            min-height: 200px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Nanum Gothic', sans-serif;
            font-size: 14px;
            resize: vertical;
        }
        
        /* ACT 택배용 작은 textarea */
        .act-stock-textarea {
            min-height: 100px !important;
            height: 100px !important;
        }

        /* 비밀번호 인증 모달 스타일 */
        #passwordModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .password-modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            min-width: 300px;
        }

        .password-modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .password-input {
            width: 200px;
            padding: 15px;
            font-size: 18px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            letter-spacing: 3px;
        }

        .password-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .password-submit {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .password-submit:hover {
            background-color: #45a049;
        }

        .password-error {
            color: #f44336;
            margin-top: 10px;
            font-size: 14px;
        }

        .main-content {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 비밀번호 인증 모달 -->
    <div id="passwordModal">
        <div class="password-modal-content">
            <h2>🔒 접근 인증</h2>
            <p>4자리 비밀번호를 입력하세요</p>
            <input type="password" id="passwordInput" class="password-input" maxlength="4" placeholder="****" autocomplete="off">
            <br>
            <button onclick="checkPassword()" class="password-submit">확인</button>
            <div id="passwordError" class="password-error" style="display: none;"></div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content">
    <div class="container">
        <h1>한결이 업무 도우미</h1>
        
        <div class="url-container" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: nowrap; width: 100%;">
            <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                <label for="usefulUrls" style="font-size: 14px; color: #555;">유용한 사이트:</label>
                <select id="usefulUrls" onchange="openSelectedUrl()" style="min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">선택하세요</option>
                    <!-- 사이트 목록은 이곳에 추가됩니다 -->
                </select>
            </div>
            
                          <div style="display: flex; flex-direction: column; gap: 8px; margin-left: 20px;">
                  <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                      <label for="excelFile" style="font-size: 14px; color: #555;">어드민 엑셀 첨부로 접수확인/신조요청 양식 만들기:</label>
                      <input type="file" id="excelFile" accept=".xlsx, .xls" style="font-size: 14px;"/>
                      <span id="extractCount" style="font-size: 14px; color: #2196F3; margin-left: 10px; font-weight: bold;"></span>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 5px;">
                      <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                          <label for="excelFile2" style="font-size: 14px; color: #555;">어드민 엑셀 첨부로 대리점별 배송요청 엑셀 생성(대리점 먼저 선택 필수)</label>
                          <input type="file" id="excelFile2" accept=".xlsx, .xls" style="font-size: 14px;"/>
                          <span id="extractCount2" style="font-size: 14px; color: #e91e63; margin-left: 10px; font-weight: bold;"></span>
                      </div>
                      <div style="margin-left: 5px;">
                          <button id="downloadDeliveryBtn" onclick="downloadDeliveryExcel()" style="display: none; background-color: #4CAF50; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">배송요청양식 다운로드</button>
                      </div>
                  </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap; margin-left: auto;">
                <label for="modelSearch" style="font-size: 14px; color: #555;">모델 검색:</label>
                <div style="position: relative; min-width: 250px;">
                    <input type="text" id="modelSearch" 
                           placeholder="예: S24, 아이폰" 
                           style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <div id="modelSearchResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; 
                          background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; 
                          overflow-y: auto; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="layout-container">
            <!-- 입력 컨테이너 (왼쪽 영역) -->
            <div class="input-column">
                <div class="form-row">
                    <div class="form-group">
                        <label for="telecom">통신사 선택:</label>
                        <select id="telecom" onchange="updateAgencies()">
                            <option value="">통신사를 선택하세요</option>
                            <option value="SK">SK</option>
                            <option value="KT">KT</option>
                            <option value="LG">LG</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="agency">대리점 선택:</label>
                        <div style="display: flex; align-items: center;">
                            <select id="agency" disabled>
                                <option value="">대리점을 선택하세요</option>
                            </select>
                            <button type="button" id="agencyInfoBtn" class="info-button" onclick="showAgencyInfo()" disabled>i</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="deviceSerial">단말기 일련번호:</label>
                        <input type="text" id="deviceSerial" class="form-control" placeholder="단말기 일련번호를 입력하세요">
                    </div>
                    
                    <div class="form-group">
                        <label for="simSerial">유심 일련번호:</label>
                        <input type="text" id="simSerial" class="form-control" placeholder="유심 일련번호를 입력하세요">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="inputText">원본 텍스트:</label>
                    <textarea id="inputText" class="input-textarea" placeholder="여기에 원본 텍스트를 입력하세요"></textarea>
                </div>
                
                <div class="button-group">
                    <button id="convertBtn" onclick="convertFormat()">변환하기</button>
                    <button id="historyBtn" onclick="openHistoryPopup()">변환내역조회</button>
                    <button id="clearBtn" onclick="clearAll()">모두 지우기</button>
                </div>
            </div>
            
            <!-- 출력 컨테이너 (오른쪽 영역) -->
            <div class="output-column">
                <div id="outputContainer" style="display: block;">
                    <!-- 럭스 전용 추가 textarea (신조/재고/개통/우주패스) -->
                    <div id="luxExtraOutputs" style="display:none;">
                        <div class="form-group">
                            <label for="luxRequestText">럭스 신조요청양식:</label>
                            <textarea id="luxRequestText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="luxStockText">럭스 재고요청양식:</label>
                            <textarea id="luxStockText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="luxMemoText">럭스 개통요청양식:</label>
                            <textarea id="luxMemoText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="luxUniverseText">럭스 우주패스양식:</label>
                            <textarea id="luxUniverseText" class="output-textarea compact-textarea"></textarea>
                        </div>
                    </div>
                    
                    <!-- 큐브 전용 추가 textarea (재고/개통/우주패스) -->
                    <div id="cubeExtraOutputs" style="display:none;">
                        <div class="form-group">
                            <label for="cubeStockText">큐브 재고요청양식:</label>
                            <textarea id="cubeStockText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="cubeOpenText">큐브 개통요청양식:</label>
                            <textarea id="cubeOpenText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="cubeUniverseText">큐브 우주패스양식:</label>
                            <textarea id="cubeUniverseText" class="output-textarea compact-textarea"></textarea>
                        </div>
                    </div>
                    
                    <!-- 드블랙 전용 추가 textarea (신조/재고/개통) -->
                    <div id="dblackExtraOutputs" style="display:none;">
                        <div class="form-group">
                            <label for="dblackRequestText">신조요청양식:</label>
                            <textarea id="dblackRequestText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="dblackStockText">재고요청양식:</label>
                            <textarea id="dblackStockText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="dblackMemoText">개통요청양식:</label>
                            <textarea id="dblackMemoText" class="output-textarea compact-textarea"></textarea>
                        </div>
                    </div>
                    <style>
                        #luxRequestText {
                            height: 130px !important;
                            min-height: 130px;
                            resize: vertical;
                        }
                        #luxStockText {
                            height: 110px !important;
                            min-height: 110px;
                            resize: vertical;
                        }
                        #luxMemoText {
                            height: 150px !important;
                            min-height: 150px;
                            resize: vertical;
                        }
                        #luxUniverseText {
                            height: 120px !important;
                            min-height: 120px;
                            resize: vertical;
                        }
                        
                        /* 큐브 textarea 스타일 */
                        #cubeStockText {
                            height: 130px !important;
                            min-height: 130px;
                            resize: vertical;
                        }
                        #cubeOpenText {
                            height: 150px !important;
                            min-height: 150px;
                            resize: vertical;
                        }
                        #cubeUniverseText {
                            height: 120px !important;
                            min-height: 120px;
                            resize: vertical;
                        }
                        /* 드블랙 신조요청 textarea 스타일 */
                        #dblackRequestText {
                            height: 150px !important;
                            min-height: 150px;
                            resize: vertical;
                        }
                        #outputText1 {
                            height: 170px !important;
                            min-height: 170px;
                        }
                        
                        /* 휴넷 textarea 스타일 */
                        #hunetConfirmText {
                            height: 150px !important;
                            min-height: 150px;
                            resize: vertical;
                        }
                        #hunetDeliveryText {
                            height: 150px !important;
                            min-height: 150px;
                            resize: vertical;
                        }
                        #hunetOpenText {
                            height: 150px !important;
                            min-height: 150px;
                            resize: vertical;
                        }
                        
                        /* 밀리언 textarea 스타일 */
                        #millionRequestText {
                            height: 100px !important;
                            min-height: 100px;
                            resize: vertical;
                        }
                        
                        /* 밀리언 배정요청 textarea 스타일 (절반 크기) */
                        #millionStockText {
                            height: 100px !important;
                            min-height: 100px;
                            resize: vertical;
                        }
                        
                        /* 한올 접수확인 textarea 스타일 (절반 크기) */
                        #hanolConfirmText {
                            height: 70px !important;
                            min-height: 70px;
                            resize: vertical;
                        }
                    </style>
                    <div id="singleOutputContainer">
                        <div class="form-group">
                            <label id="outputTextLabel" for="outputText">변환된 텍스트:</label>
                            <textarea id="outputText" class="output-textarea"></textarea>
                        </div>
                    </div>
                    
                    <div id="splitOutputContainer" style="display: none;">
                    </div>
                    
                    <!-- ACT(택배) 전용 추가 textarea (접수확인/개통요청) -->
                    <div id="actExtraOutputs" style="display:none;">
                        <div class="form-group">
                            <label for="actStockText">ACT(택배) 접수확인양식:</label>
                            <textarea id="actStockText" class="output-textarea compact-textarea act-stock-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="actOpenText">ACT(택배) 개통요청양식:</label>
                            <textarea id="actOpenText" class="output-textarea compact-textarea"></textarea>
                        </div>
                    </div>
                    
                    <!-- 비앤컴 전용 추가 textarea (접수확인&신조요청/개통요청) -->
                    <div id="bncomExtraOutputs" style="display:none;">
                        <div class="form-group">
                            <label for="bncomStockText">비앤컴 접수확인&신조요청:</label>
                            <textarea id="bncomStockText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="bncomOpenText">비앤컴 개통요청:</label>
                            <textarea id="bncomOpenText" class="output-textarea compact-textarea"></textarea>
                        </div>
                    </div>
                    
                    <!-- 휴넷 전용 추가 textarea (접수확인/배송요청/개통요청) -->
                    <div id="hunetExtraOutputs" style="display:none;">
                        <div class="form-group">
                            <label for="hunetConfirmText">휴넷 접수확인양식:</label>
                            <textarea id="hunetConfirmText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="hunetDeliveryText">휴넷 배송요청양식:</label>
                            <textarea id="hunetDeliveryText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="hunetOpenText">휴넷 개통요청양식:</label>
                            <textarea id="hunetOpenText" class="output-textarea compact-textarea"></textarea>
                        </div>
                    </div>
                    
                    <!-- 밀리언 전용 추가 textarea (신조요청/배정요청/개통요청) -->
                    <div id="millionExtraOutputs" style="display:none;">
                        <div class="form-group">
                            <label for="millionRequestText">밀리언 신조요청:</label>
                            <textarea id="millionRequestText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="millionStockText">밀리언 배정요청:</label>
                            <textarea id="millionStockText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="millionMemoText">밀리언 개통요청:</label>
                            <textarea id="millionMemoText" class="output-textarea compact-textarea"></textarea>
                        </div>
                    </div>
                    
                    <!-- 오앤티 전용 추가 textarea (신조요청/배정요청/개통요청) -->
                    <div id="ontExtraOutputs" style="display:none;">
                        <div class="form-group">
                            <label for="ontRequestText">오앤티 신조요청:</label>
                            <textarea id="ontRequestText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="ontStockText">오앤티 배정요청:</label>
                            <textarea id="ontStockText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="ontMemoText">오앤티 개통요청:</label>
                            <textarea id="ontMemoText" class="output-textarea compact-textarea"></textarea>
                        </div>
                    </div>
                    
                    <!-- 장천 전용 추가 textarea (배송요청/개통요청) -->
                    <div id="jangcheonExtraOutputs" style="display:none;">
                        <div class="form-group">
                            <label for="jangcheonDeliveryText">장천 배송요청:</label>
                            <textarea id="jangcheonDeliveryText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="jangcheonOpenText">장천 개통요청:</label>
                            <textarea id="jangcheonOpenText" class="output-textarea compact-textarea"></textarea>
                        </div>
                    </div>
                    
                    <!-- 한올 전용 추가 textarea (접수확인/배송요청/개통요청) -->
                    <div id="hanolExtraOutputs" style="display:none;">
                        <div class="form-group">
                            <label for="hanolConfirmText">한올 접수확인양식:</label>
                            <textarea id="hanolConfirmText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="hanolDeliveryText">한올 배송요청양식:</label>
                            <textarea id="hanolDeliveryText" class="output-textarea compact-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="hanolOpenText">한올 개통요청양식:</label>
                            <textarea id="hanolOpenText" class="output-textarea compact-textarea"></textarea>
                        </div>
                    </div>
                    
                    <div id="keyValueTableContainer" style="display: none;">
                        <div class="copy-notice">각 항목을 클릭하면 해당 값이 클립보드에 복사됩니다.</div>
                        <table class="key-value-table" id="keyValueTable">
                            <tbody>
                                <!-- 키-값 행이 여기에 추가됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 양식이 여러개인 경우를 위한 템플릿 -->
                <div id="splitOutputTemplate" style="display: none;">
                    <div class="output-section">
                        <h3>재고요청:</h3>
                        <textarea id="outputText1" class="output-textarea"></textarea>
                    </div>
                    <div class="output-section">
                        <h3>개통요청:</h3>
                        <textarea id="outputText2" class="output-textarea"></textarea>
                    </div>
                </div>
                
                <!-- 키-값 테이블 템플릿 -->
                <div id="keyValueTableTemplate" style="display: none;">
                    <div class="copy-notice">각 항목을 클릭하면 해당 값이 클립보드에 복사됩니다.</div>
                    <table class="key-value-table" id="keyValueTable">
                        <tbody>
                            <!-- 키-값 행이 여기에 추가됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast">클립보드에 복사되었습니다!</div>
    
    <!-- 변환 이력 팝업 -->
    <div id="historyPopup" class="popup-overlay">
        <div class="popup-content" style="max-width: 800px;">
            <span class="popup-close" onclick="closeHistoryPopup()">&times;</span>
            <h3 class="popup-title">변환 이력</h3>
            <div id="historyList" class="history-list">
                <!-- 이력 목록이 여기에 표시됩니다 -->
            </div>
            <div class="history-actions">
                <button onclick="clearHistory()" class="btn-clear-history">전체 삭제</button>
            </div>
        </div>
    </div>
    
    <!-- 대리점 메모 팝업 -->
    <div id="memoPopup" class="popup-overlay">
        <div class="popup-content">
            <span class="popup-close" onclick="closeAgencyInfo()">&times;</span>
            <h3 class="popup-title" id="popupTitle">대리점 업무 메모</h3>
            <div class="memo-content" id="memoContent"></div>
        </div>
    </div>
    
    <script>
        // 템플릿 관리 클래스
        class TemplateManager {
            static getTemplate(telecom, agency) {
                const agencyConfig = TELECOM_CONFIG[telecom]?.agencies[agency];
                if (!agencyConfig) return null;
                
                return agencyConfig.templates || agencyConfig.template;
            }

            static applyTemplate(telecom, agency, customerInfo) {
                const template = this.getTemplate(telecom, agency);
                if (!template) throw new Error('템플릿을 찾을 수 없습니다.');

                const agencyConfig = TELECOM_CONFIG[telecom].agencies[agency];
                
                switch(agencyConfig.outputType) {
                    case 'split':
                        return {
                            stockRequest: template.stockRequest(customerInfo),
                            openRequest: template.openRequest(customerInfo)
                        };
                    case 'multi':
                        // 휴넷과 오앤티의 경우 특별한 처리
                        if (agency === '제이/휴넷') {
                            return {
                                confirm: template.confirm(customerInfo),
                                delivery: template.delivery(customerInfo),
                                open: template.open(customerInfo)
                            };
                        } else if (agency === '오앤티') {
                            return {
                                request: template.request(customerInfo),
                                delivery: template.delivery(customerInfo),
                                open: template.open(customerInfo)
                            };
                        } else if (agency === '장천') {
                            return {
                                delivery: template.delivery(customerInfo),
                                open: template.open(customerInfo)
                            };
                        } else if (agency === '럭스') {
                            return {
                                request: template.request(customerInfo),
                                stock: template.delivery(customerInfo),  // 배송/재고 요청서를 재고요청양식으로
                                open: template.open(customerInfo),       // 개통요청양식
                                universe: template.universe(customerInfo) // 우주패스양식
                            };
                        } else if (agency === '큐브') {
                            return {
                                stock: template.stockRequest(customerInfo),   // 재고요청
                                open: template.openRequest(customerInfo),     // 개통요청
                                universe: template.universe(customerInfo)     // 우주패스양식
                            };
                        } else if (agency === '한올') {
                            return {
                                confirm: template.confirm(customerInfo),   // 접수확인양식
                                delivery: template.delivery(customerInfo), // 배송요청양식
                                open: template.open(customerInfo)          // 개통요청양식
                            };
                    } else {
                            return {
                                request: template.request(customerInfo),
                                stock: template.stock(customerInfo),
                                memo: template.memo(customerInfo)
                            };
                        }
                    case 'table':
                        return template(customerInfo);
                    default:
                        return template(customerInfo);
                }
            }
        }

        // 출력 관리 클래스
        class OutputManager {
            static showOutput(result, outputType, telecom, agency) {
                // 모든 출력 컨테이너 초기화
                this.hideAllContainers();
                
                switch(outputType) {
                    case 'split':
                        this.showSplitOutput(result);
                        break;
                    case 'multi':
                        this.showMultiOutput(result, agency);
                        break;
                    case 'table':
                        this.showTableOutput(result);
                        break;
                    default:
                        this.showSingleOutput(result);
                }
            }

            static hideAllContainers() {
                const containers = [
                    'luxExtraOutputs',
                    'dblackExtraOutputs',
                    'singleOutputContainer',
                    'splitOutputContainer',
                    'keyValueTableContainer',
                    'actExtraOutputs',
                    'bncomExtraOutputs',
                    'hunetExtraOutputs',
                    'millionExtraOutputs',
                    'ontExtraOutputs',
                    'jangcheonExtraOutputs',
                    'hanolExtraOutputs'
                ];
                
                containers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.style.display = 'none';
                });
                
                // 큐브 컨테이너도 숨기기
                const cubeContainer = document.getElementById('cubeExtraOutputs');
                if (cubeContainer) cubeContainer.style.display = 'none';
                
                // 추가 텍스트 div 제거
                const additionalTextDiv = document.getElementById('additionalTextDiv');
                if (additionalTextDiv) {
                    additionalTextDiv.remove();
                }
            }

            static showSplitOutput(result) {
                const container = document.getElementById('splitOutputContainer');
                if (!container) return;

                // 현재 선택된 대리점 가져오기
                const agencySelect = document.getElementById('agency');
                const selectedAgency = agencySelect ? agencySelect.value : '';

                // 카파, 삼보(온라인), 이앤티일 때 특별 라벨 사용
                let firstLabel = '접수확인';
                if (selectedAgency === '카파') {
                    firstLabel = '배송요청';
                } else if (selectedAgency === '삼보(온라인)') {
                    firstLabel = '재고요청';
                } else if (selectedAgency === '이앤티') {
                    firstLabel = '배송요청';
                }

                container.style.display = 'block';
                container.innerHTML = `
                    <div class="form-group">
                        <label for="outputText1">${selectedAgency} ${firstLabel}:</label>
                        <textarea id="outputText1" class="output-textarea">${result.stockRequest || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="outputText2">${selectedAgency} 개통요청:</label>
                        <textarea id="outputText2" class="output-textarea">${result.openRequest || ''}</textarea>
                    </div>
                `;
            }

            static showMultiOutput(result, agency) {
                let container;
                
                // 대리점에 따른 컨테이너 선택
                if (agency === '드블랙') {
                    container = document.getElementById('dblackExtraOutputs');
                } else if (agency === '제이/휴넷') {
                    container = document.getElementById('hunetExtraOutputs');
                } else if (agency === '밀리언') {
                    container = document.getElementById('millionExtraOutputs');
                } else if (agency === '오앤티') {
                    container = document.getElementById('ontExtraOutputs');
                } else if (agency === '장천') {
                    container = document.getElementById('jangcheonExtraOutputs');
                } else if (agency === '한올') {
                    container = document.getElementById('hanolExtraOutputs');
                } else if (agency === '럭스') {
                    container = document.getElementById('luxExtraOutputs');
                } else if (agency === '큐브') {
                    container = document.getElementById('cubeExtraOutputs');
                    } else {
                    container = document.getElementById('luxExtraOutputs');
                }
                
                if (!container) return;
                container.style.display = 'block';

                if (agency === '드블랙') {
                    // 드블랙 대리점용 출력 처리
                    container.innerHTML = `
                        <div class="form-group">
                            <label for="dblackRequestText">드블랙 신조요청양식:</label>
                            <textarea id="dblackRequestText" class="output-textarea compact-textarea">${result.request || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="dblackStockText">드블랙 재고요청양식:</label>
                            <textarea id="dblackStockText" class="output-textarea compact-textarea">${result.stock || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="dblackMemoText">드블랙 개통요청양식:</label>
                            <textarea id="dblackMemoText" class="output-textarea compact-textarea">${result.memo || ''}</textarea>
                        </div>
                    `;
                } else if (agency === '제이/휴넷') {
                    // 휴넷 대리점용 출력 처리 (3개 textarea)
                    const confirmText = document.getElementById('hunetConfirmText');
                    const deliveryText = document.getElementById('hunetDeliveryText');
                    const openText = document.getElementById('hunetOpenText');
                    
                    if (confirmText) confirmText.value = result.confirm || '';
                    if (deliveryText) deliveryText.value = result.delivery || '';
                    if (openText) openText.value = result.open || '';
                } else if (agency === '밀리언') {
                    // 밀리언 대리점용 출력 처리
                    const requestText = document.getElementById('millionRequestText');
                    const stockText = document.getElementById('millionStockText');
                    const memoText = document.getElementById('millionMemoText');
                    
                    if (requestText) requestText.value = result.request || '';
                    if (stockText) stockText.value = result.stock || '';
                    if (memoText) memoText.value = result.memo || '';
                } else if (agency === '오앤티') {
                    // 오앤티 대리점용 출력 처리
                    const requestText = document.getElementById('ontRequestText');
                    const stockText = document.getElementById('ontStockText');
                    const memoText = document.getElementById('ontMemoText');
                    
                    if (requestText) requestText.value = result.request || '';
                    if (stockText) stockText.value = result.delivery || '';
                    if (memoText) memoText.value = result.open || '';
                } else if (agency === '장천') {
                    // 장천 대리점용 출력 처리
                    const deliveryText = document.getElementById('jangcheonDeliveryText');
                    const openText = document.getElementById('jangcheonOpenText');
                    
                    if (deliveryText) deliveryText.value = result.delivery || '';
                    if (openText) openText.value = result.open || '';
                } else if (agency === '한올') {
                    // 한올 대리점용 출력 처리 (3개 textarea)
                    const confirmText = document.getElementById('hanolConfirmText');
                    const deliveryText = document.getElementById('hanolDeliveryText');
                    const openText = document.getElementById('hanolOpenText');
                    
                    if (confirmText) confirmText.value = result.confirm || '';
                    if (deliveryText) deliveryText.value = result.delivery || '';
                    if (openText) openText.value = result.open || '';
                } else if (agency === '럭스') {
                    // 럭스 대리점용 출력 처리 (4개 textarea)
                    const requestText = document.getElementById('luxRequestText');
                    const stockText = document.getElementById('luxStockText');
                    const openText = document.getElementById('luxMemoText');
                    const universeText = document.getElementById('luxUniverseText');
                    
                    if (requestText) requestText.value = result.request || '';
                    if (stockText) stockText.value = result.stock || '';
                    if (openText) openText.value = result.open || '';
                    if (universeText) universeText.value = result.universe || '';
                } else if (agency === '큐브') {
                    // 큐브 대리점용 출력 처리 (3개 textarea)
                    const stockText = document.getElementById('cubeStockText');
                    const openText = document.getElementById('cubeOpenText');
                    const universeText = document.getElementById('cubeUniverseText');
                    
                    if (stockText) stockText.value = result.stock || '';
                    if (openText) openText.value = result.open || '';
                    if (universeText) universeText.value = result.universe || '';
                } else {
                    // 기타 대리점용 출력 처리 (기본 럭스 형태)
                    container.innerHTML = `
                        <div class="form-group">
                            <label for="luxRequestText">신조요청양식:</label>
                            <textarea id="luxRequestText" class="output-textarea compact-textarea">${result.request || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="luxStockText">재고요청양식:</label>
                            <textarea id="luxStockText" class="output-textarea compact-textarea">${result.stock || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="luxMemoText">개통요청양식:</label>
                            <textarea id="luxMemoText" class="output-textarea compact-textarea">${result.open || ''}</textarea>
                        </div>
                    `;
                }
            }

            static showTableOutput(result) {
                const container = document.getElementById('keyValueTableContainer');
                if (!container) return;

                container.style.display = 'block';
                // 테이블 출력 로직 구현 - result.tableData를 전달
                createKeyValueTable(result.tableData || result);
                
                // additionalText가 있으면 테이블 아래에 표시
                if (result.additionalText) {
                    let additionalTextDiv = document.getElementById('additionalTextDiv');
                    if (!additionalTextDiv) {
                        additionalTextDiv = document.createElement('div');
                        additionalTextDiv.id = 'additionalTextDiv';
                        additionalTextDiv.style.cssText = `
                            margin-top: 20px;
                            padding: 15px;
                            background-color: #f8f9fa;
                            border: 1px solid #e9ecef;
                            border-radius: 5px;
                            white-space: pre-line;
                            font-family: 'Nanum Gothic', sans-serif;
                            line-height: 1.5;
                        `;
                        container.appendChild(additionalTextDiv);
                    }
                    additionalTextDiv.textContent = result.additionalText;
                }
            }

            static showSingleOutput(result) {
                const container = document.getElementById('singleOutputContainer');
                if (!container) return;

                container.style.display = 'block';
                document.getElementById('outputText').value = result;
            }
        }

        // 통신사 선택에 따라 대리점 목록 업데이트
        function updateAgencies() {
            const telecomSelect = document.getElementById('telecom');
            const agencySelect = document.getElementById('agency');
            const agencyInfoBtn = document.getElementById('agencyInfoBtn');
            
            // 대리점 선택 초기화
            agencySelect.innerHTML = '<option value="">대리점을 선택하세요</option>';
            agencySelect.disabled = true;
            agencyInfoBtn.disabled = true;
            
            const selectedTelecom = telecomSelect.value;
            
            if (selectedTelecom) {
                // 선택된 통신사에 해당하는 대리점 목록 추가
                agencies[selectedTelecom].forEach(agency => {
                    const option = document.createElement('option');
                    option.value = agency;
                    option.textContent = agency;
                    agencySelect.appendChild(option);
                });
                
                // 대리점 선택 활성화
                agencySelect.disabled = false;
                agencyInfoBtn.disabled = false;
            }
        }

        // 텍스트에서 고객 정보 추출
        // function extractCustomerInfo(text) {
        //     const customerInfo = {};
            
        //     // 정규식 패턴으로 각 항목 추출
        //     const patterns = {
        //         '전화번호': /\*{1,2}(?:전\s*화\s*번\s*호|개\s*통\s*번\s*호)\s*[-:：]\s*([^\n]+)/i,
        //         '개통번호': /\*{1,2}(?:전\s*화\s*번\s*호|개\s*통\s*번\s*호)\s*[-:：]\s*([^\n]+)/i,
        //         '모델명': /\*{1,2}모\s*델\s*명\s*[-:：]\s*([^\n]+)/i,
        //         '색상': /\*{1,2}색\s*상\s*[-:：]\s*([^\n]+)/i,
        //         '고객명': /\*{1,2}(?:고\s*객\s*명|가\s*입\s*자\s*명)\s*[-:：]\s*([^\n]+)/i,
        //         '가입자명': /\*{1,2}(?:고\s*객\s*명|가\s*입\s*자\s*명)\s*[-:：]\s*([^\n]+)/i,
        //         '주민번호': /\*{1,2}(?:주\s*민\s*번\s*호|생\s*년\s*월\s*일)\s*[-:：]\s*([^\n]+)/i,
        //         '생년월일': /\*{1,2}(?:주\s*민\s*번\s*호|생\s*년\s*월\s*일)\s*[-:：]\s*([^\n]+)/i,
        //         '택배주소': /\*{1,2}택\s*배\s*(?:주\s*소|주\s*소\s*지)?\s*[-:：]\s*([^\n]+)/i,
        //         '배송주소지': /\*{1,2}(?:택\s*배|배\s*송)\s*(?:주\s*소|주\s*소\s*지)?\s*[-:：]\s*([^\n]+)/i,
        //         '현재통신사': /\*{1,2}현\s*재\s*통\s*신\s*사\s*[-:：]\s*([^\n]+)/i,
        //         '요금제': /\*{1,2}요\s*금\s*제\s*[-:：]\s*([^\n]+)/i,
        //         '가입유형': /\*{1,2}가\s*입\s*유\s*형\s*[-:：]\s*([^\n]+)/i,
        //         '할인유형': /\*{1,2}할\s*인\s*(?:유\s*형|방\s*식)\s*[-:：]\s*([^\n]+)/i,
        //         '유심': /\*{1,2}유\s*심\s*(?:비\s*용)?\s*[-:：]\s*([^\n]+)/i,
        //         '부가서비스': /\*{1,2}부\s*가\s*서\s*비\s*스\s*[-:：]\s*([^\n]+)/i,
        //         '보험': /\*{1,2}보\s*험\s*[-:：]\s*([^\n]+)/i,
        //         '법대정보': /\*{1,2}법\s*대\s*정\s*보\s*[-:：]\s*([^/]+)\s*\/\s*([\d-]+)\s*\/\s*([\d-]+)/i
        //     };
            
        //     // 각 패턴에 맞게 정보 추출
        //     for (const [key, pattern] of Object.entries(patterns)) {
        //         const match = text.match(pattern);
        //         if (match) {
        //             if (key === '법대정보') {
        //                 // 법대정보가 있는 경우 (미성년자)
        //                 customerInfo['미성년자여부'] = 'Y';
        //                 customerInfo['법정대리인이름'] = match[1].trim();
        //                 customerInfo['법정대리인주민번호'] = match[2].trim().replace(/\s*-\s*/g, '-');
        //                 customerInfo['법정대리인연락처'] = match[3].trim().replace(/[\s\-]/g, '').replace(/(\d{3})(\d{3,4})(\d{4})/, '$1-$2-$3');
        //                 continue;
        //             }
                    
        //             // 일반 필드 처리
        //             if (match[1]) {
        //                 let value = match[1].trim();
                        
        //                 // 전화번호/개통번호 포맷 정규화 (01012345678 -> 010-1234-5678)
        //                 if ((key === '전화번호' || key === '개통번호') && value) {
        //                     // 괄호 안의 내용 제거 (예: (휴대전화) 제거)
        //                     value = value.replace(/\([^)]*\)/g, '').trim();
        //                     // 모든 공백과 하이픈 제거
        //                     const numbers = value.replace(/[^\d]/g, '');
        //                     // 01012345678 -> 010-1234-5678 형식으로 변환
        //                     if (numbers.length >= 10) {
        //                         value = numbers.replace(/(\d{3})(\d{3,4})(\d{4})/, '$1-$2-$3');
        //                         customerInfo[key] = value;  // 변환된 값 저장
                                
        //                         // 전화번호에서 개통번호 추출 (개통번호가 없을 경우에만)
        //                         if (key === '전화번호' && !customerInfo['개통번호']) {
        //                             customerInfo['개통번호'] = value;  // 전화번호를 개통번호로도 저장
        //                         }
        //                     }
        //                 }
                        
        //                 // 생년월일/주민번호 포맷 정규화 (000718 - 3251915 -> 000718-3251915)
        //                 if ((key === '생년월일' || key === '주민번호') && value) {
        //                     // 하이픈 주변의 공백 제거
        //                     value = value.replace(/\s*-\s*/g, '-');
        //                 }
                        
        //                 // 배송주소/택배주소에서 "/" 이후의 전화번호 부분 제거
        //                 if ((key === '택배주소' || key === '배송주소지') && value) {
        //                     // "/" 이후의 전화번호 패턴 제거 (예: / 010-8316-1294)
        //                     value = value.replace(/\s*\/\s*010-\d{3,4}-\d{4}.*$/, '').trim();
        //                 }
                        
        //                 customerInfo[key] = value;
        //             } else {
        //                 customerInfo[key] = '';
        //             }
        //         } else {
        //             customerInfo[key] = '';
        //         }
        //     }
            
        //     // 미성년자 여부 기본값 설정 (법대정보가 없으면 'N')
        //     if (!customerInfo.hasOwnProperty('미성년자여부')) {
        //         customerInfo['미성년자여부'] = 'N';
        //         customerInfo['법정대리인이름'] = '';
        //         customerInfo['법정대리인주민번호'] = '';
        //         customerInfo['법정대리인연락처'] = '';
        //     }
            
        //     // 개통번호와 전화번호 통합 처리 (전화번호가 없을 경우 개통번호 사용)
        //     if (!customerInfo['전화번호'] && customerInfo['개통번호']) {
        //         customerInfo['전화번호'] = customerInfo['개통번호'];
        //     }
            
        //     // 고객명과 가입자명 통합 처리 (고객명이 없을 경우 가입자명 사용)
        //     if (!customerInfo['고객명'] && customerInfo['가입자명']) {
        //         customerInfo['고객명'] = customerInfo['가입자명'];
        //     }
            
        //     // 주민번호와 생년월일 통합 처리 (주민번호가 없을 경우 생년월일 사용)
        //     if (!customerInfo['주민번호'] && customerInfo['생년월일']) {
        //         customerInfo['주민번호'] = customerInfo['생년월일'];
        //     }
            
        //     // 택배주소와 배송주소지 통합 처리 (택배주소가 없을 경우 배송주소지 사용)
        //     if (!customerInfo['택배주소'] && customerInfo['배송주소지']) {
        //         customerInfo['택배주소'] = customerInfo['배송주소지'];
        //     }
            
        //     // 1. Parse subscription, discount, and telecom info using the new function
        //     let subInfo;
        //     try {
        //         // utils.js에서 전역으로 노출된 함수 사용
        //         if (typeof window.parseSubscriptionAndDiscountInfo === 'function') {
        //                                  subInfo = window.parseSubscriptionAndDiscountInfo({
        //                  '가입유형': customerInfo['가입유형'] || '',
        //                  '할인유형': customerInfo['할인유형'] || '',
        //                  '현재통신사': customerInfo['현재통신사'] || ''
        //              });
        //              console.log('parseSubscriptionAndDiscountInfo 실행 성공');
        //              console.log('입력 데이터:', {
        //                  '가입유형': customerInfo['가입유형'] || '',
        //                  '할인유형': customerInfo['할인유형'] || '',
        //                  '현재통신사': customerInfo['현재통신사'] || ''
        //              });
        //              console.log('파싱 결과:', subInfo);
        //         } else {
        //             throw new Error('parseSubscriptionAndDiscountInfo 함수를 찾을 수 없습니다.');
        //         }
        //     } catch (error) {
        //         console.error('parseSubscriptionAndDiscountInfo 오류:', error);
        //         // 오류 발생 시 기본값 사용
        //         subInfo = {
        //             subscriptionType: customerInfo['가입유형'] || '',
        //             discountType: customerInfo['할인유형'] || '',
        //             currentTelecom: customerInfo['현재통신사'] || '',
        //             discountMonths: '',
        //             contractType: ''
        //         };
        //     }

        //     // 2. Update customer info with parsed values
        //     customerInfo['가입유형'] = subInfo.subscriptionType;
        //     customerInfo['할인유형'] = subInfo.discountType;
        //     customerInfo['현재통신사'] = subInfo.currentTelecom;
            
        //     // 2-1. 가입유형이 비어있는 경우 현재통신사와 선택된 통신사 비교하여 자동 설정
        //     if (!customerInfo['가입유형'] || customerInfo['가입유형'].trim() === '') {
        //         alert('어드민 메모의 가입유형이 확인되지않아 자동 변환을 시작합니다. \n 현재통신사와 선택된 통신사를 비교하여 가입유형을 자동 설정합니다. \n 변환된 양식을 한번더 체크하세요.');
        //         // 현재 선택된 통신사 가져오기
        //         const selectedTelecom = document.getElementById('telecom') ? document.getElementById('telecom').value : '';
        //         const currentTelecom = customerInfo['현재통신사'] || '';
                
        //         console.log('가입유형 자동 판단:', {
        //             '선택된통신사': selectedTelecom,
        //             '현재통신사': currentTelecom
        //         });
                
        //         // 현재통신사와 선택된 통신사 비교
        //         if (currentTelecom && selectedTelecom) {
        //             if (currentTelecom.toLowerCase().trim() !== selectedTelecom.toLowerCase().trim()) {
        //                 customerInfo['가입유형'] = '번호이동';
        //                 console.log('가입유형 자동설정: 번호이동 (현재통신사 ≠ 선택통신사)');
        //             } else {
        //                 customerInfo['가입유형'] = '기기변경';
        //                 console.log('가입유형 자동설정: 기기변경 (현재통신사 = 선택통신사)');
        //             }
        //         } else {
        //             console.log('가입유형 자동설정 불가: 통신사 정보 부족');
        //         }
        //     }
            
        //     console.log('적용 후 customerInfo:', {
        //         '가입유형': customerInfo['가입유형'],
        //         '할인유형': customerInfo['할인유형'],
        //         '현재통신사': customerInfo['현재통신사']
        //     });

        //     // 3. Set 공시선약여부 and 약정개월수 based on discount type
        //     if (subInfo.discountType === '공시지원') {
        //         customerInfo['공시선약여부'] = '공시지원';
        //         customerInfo['약정개월수'] = subInfo.discountMonths || '24개월';
        //     } else if (subInfo.discountType === '선택약정' || subInfo.discountType === '선약') {
        //         customerInfo['공시선약여부'] = subInfo.discountType;
        //         customerInfo['약정개월수'] = subInfo.discountMonths || '';
        //     } else {
        //         customerInfo['공시선약여부'] = '';
        //         customerInfo['약정개월수'] = '';
        //     }
            
        //     console.log('최종 약정 정보:', {
        //         '공시선약여부': customerInfo['공시선약여부'],
        //         '약정개월수': customerInfo['약정개월수']
        //     });
            
        //     // 출고가, 공시, 추지, 전환지원금, 프리할부, 할부/현금 정보 추출
        //     // 1. 기본값 초기화
        //     customerInfo['추지'] = '0';
        //     customerInfo['전환지원금'] = '0';
        //     customerInfo['프리할부'] = '0';
            
        //     // 2. 괄호 포함 패턴 (예: **출고가 (1,540,000)- 공시(700,000)- 전지(100,000) = 현금(740,000))
        //     const parenthesizedPattern = /\*\*\s*출고가\s*[\(\[]?\s*([\d,]+)\s*[\]\)]?\s*-\s*공시\s*[\(\[]?\s*([\d,]+)\s*[\]\)]?\s*(?:-\s*(?:추지|추가지원)\s*[\(\[]?\s*([\d,]+)\s*[\]\)]?)?\s*(?:-\s*(?:전지|전환지원금?|전환)\s*[\(\[]?\s*([\d,]+)\s*[\]\)]?)?\s*(?:-\s*프리할부\s*[\(\[]?\s*([\d,]+)\s*[\]\)]?)?\s*=\s*(할부\d*|\ud604\uae08)\s*[\(\[]?\s*([\d,]+)\s*[\]\)]?/i;
            
        //     // 3. 일반 패턴 (괄호 없음, 기존 형식 유지)
        //     const normalPattern = /\*\*\s*출고가\s+([\d,]+)\s*-\s*공시\s+([\d,]+)\s*(?:-\s*(?:추지|추가지원)\s+([\d,]+))?\s*(?:-\s*(?:전지|전환지원금?|전환)\s+([\d,]+))?\s*(?:-\s*프리할부\s+([\d,]+))?\s*=\s*(할부\d*|\ud604\uae08)\s*([\d,]+)/i;
            
        //     // 4. 패턴 매칭 시도 (괄호 포함 패턴 먼저 시도)
        //     let match = text.match(parenthesizedPattern) || text.match(normalPattern);
            
        //     if (match) {
        //         // 매칭된 그룹 인덱스 정리
        //         const groups = {
        //             출고가: match[1] || '0',
        //             공시: match[2] || '0',
        //             추지: match[3] || '0',
        //             전환지원금: match[4] || '0',
        //             프리할부: match[5] || '0',
        //             할부현금: match[6] || '현금',
        //             최종구매가: match[7] || '0'
        //         };
                
        //         // 고객 정보에 할당 (0이 아닌 경우에만 업데이트)
        //         customerInfo['출고가'] = groups.출고가.trim();
        //         customerInfo['공시'] = groups.공시.trim();
        //         if (groups.추지 !== '0') customerInfo['추지'] = groups.추지.trim();
        //         if (groups.전환지원금 !== '0') customerInfo['전환지원금'] = groups.전환지원금.trim();
        //         if (groups.프리할부 !== '0') customerInfo['프리할부'] = groups.프리할부.trim();
                
        //         console.log('매칭된 정보:', groups); // 디버깅용
                
        //         // 할부/현금 여부 확인
        //         if (groups.할부현금.includes('할부')) {
        //             customerInfo['할부현금여부'] = '할부';
                    
        //             // 할부개월수 추출
        //             const installmentMatch = groups.할부현금.match(/(\d+)/);
        //             if (installmentMatch && installmentMatch[1]) {
        //                 customerInfo['할부개월수'] = installmentMatch[1] + '개월';
        //             } else {
        //                 customerInfo['할부개월수'] = '24개월'; // 기본값
        //             }
        //         } else {
        //             customerInfo['할부현금여부'] = '현금';
        //             customerInfo['할부개월수'] = '';
        //         }
                
        //         customerInfo['최종구매가'] = groups.최종구매가.trim();
        //     } else {
        //         // 추가 패턴 시도: 추지만 있는 경우 (괄호 없음)
        //         const pricePattern = /\*\*\s*출고가\s+([\d,]+)\s*-\s*공시\s+([\d,]+)(?:\s*-\s*(?:추지|추가지원)\s+([\d,]+))?(?:\s*-\s*프리할부\s+([\d,]+))?\s*=\s*(할부\d*|\ud604\uae08)\s*([\d,]+)/i;
        //         const priceMatch = text.match(pricePattern);
                
        //         if (priceMatch) {
        //             customerInfo['출고가'] = priceMatch[1].trim();
        //             customerInfo['공시'] = priceMatch[2].trim();
        //             if (priceMatch[3]) customerInfo['추지'] = priceMatch[3].trim();
        //             if (priceMatch[4]) customerInfo['프리할부'] = priceMatch[4].trim();
                    
        //             // 할부/현금 여부 확인
        //             if (priceMatch[5].includes('할부')) {
        //                 customerInfo['할부현금여부'] = '할부';
                        
        //                 // 할부개월수 추출
        //                 const installmentMatch = priceMatch[5].match(/(\d+)/);
        //                 if (installmentMatch && installmentMatch[1]) {
        //                     customerInfo['할부개월수'] = installmentMatch[1] + '개월';
        //                 } else {
        //                     customerInfo['할부개월수'] = '24개월'; // 기본값
        //                 }
        //             } else {
        //                 customerInfo['할부현금여부'] = '현금';
        //                 customerInfo['할부개월수'] = '';
        //             }
                    
        //             customerInfo['최종구매가'] = priceMatch[6].trim();
        //         } else {
        //             // 현금 형식 패턴 확인 (추지와 전환지원금이 모두 있는 경우)
        //             const cashConversionPattern = /\*\*\s*출고가\s+([\d,]+)\s*-\s*공시\s+([\d,]+)(?:\s*-\s*(?:추지|추가지원)\s+([\d,]+))?\s*(?:-\s*(?:전지|전환지원금?|전환)\s+([\d,]+))?\s*(?:-\s*프리할부\s+([\d,]+))?\s*=\s*현금\s*([\d,]+)/i;
        //             const cashConversionMatch = text.match(cashConversionPattern);
                    
        //             if (cashConversionMatch) {
        //                 customerInfo['출고가'] = cashConversionMatch[1].trim();
        //                 customerInfo['공시'] = cashConversionMatch[2].trim();
        //                 if (cashConversionMatch[3]) customerInfo['추지'] = cashConversionMatch[3].trim();
        //                 if (cashConversionMatch[4]) customerInfo['전환지원금'] = cashConversionMatch[4].trim();
        //                 if (cashConversionMatch[5]) customerInfo['프리할부'] = cashConversionMatch[5].trim();
        //                 customerInfo['추지'] = cashConversionMatch[3].trim();
        //                 customerInfo['전환지원금'] = cashConversionMatch[5].trim();
        //                 customerInfo['프리할부'] = cashConversionMatch[6] ? cashConversionMatch[6].trim() : '0';
        //                 customerInfo['할부현금여부'] = '현금';
        //                 customerInfo['할부개월수'] = '';
        //                 customerInfo['최종구매가'] = cashConversionMatch[7].trim();
        //             } else {
        //                 // 기존 현금 형식 패턴 (전환지원금 없는 경우)
        //                 const cashPattern = /\*\*출고가\s+([\d,]+)\s*-\s*공시\s+([\d,]+)\s*-\s*추지\s+([\d,]+)(?:\s*-\s*프리할부\s+([\d,]+))?\s*=\s*현금\s*([\d,]+)/;
        //                 const cashMatch = text.match(cashPattern);
                        
        //                 if (cashMatch) {
        //                     customerInfo['출고가'] = cashMatch[1].trim();
        //                     customerInfo['공시'] = cashMatch[2].trim();
        //                     customerInfo['추지'] = cashMatch[3].trim();
        //                     customerInfo['전환지원금'] = '0';
        //                     customerInfo['프리할부'] = cashMatch[4] ? cashMatch[4].trim() : '0';
        //                     customerInfo['할부현금여부'] = '현금';
        //                     customerInfo['할부개월수'] = '';
        //                     customerInfo['최종구매가'] = cashMatch[5].trim();
        //                 } else {
        //                     // 할부 형식 패턴 확인 (전환지원금 포함)
        //                     const installmentConversionPattern = /\*\*출고가\s+([\d,]+)\s*-\s*공시\s+([\d,]+)\s*-\s*추지\s+([\d,]+)\s*-\s*(전환지원금?|전환)\s+([\d,]+)(?:\s*-\s*프리할부\s+([\d,]+))?\s*=\s*할부(\d+)\s*([\d,]+)/;
        //                     const installmentConversionMatch = text.match(installmentConversionPattern);
                            
        //                     if (installmentConversionMatch) {
        //                         customerInfo['출고가'] = installmentConversionMatch[1].trim();
        //                         customerInfo['공시'] = installmentConversionMatch[2].trim();
        //                         customerInfo['추지'] = installmentConversionMatch[3].trim();
        //                         customerInfo['전환지원금'] = installmentConversionMatch[5].trim();
        //                         customerInfo['프리할부'] = installmentConversionMatch[6] ? installmentConversionMatch[6].trim() : '0';
        //                         customerInfo['할부현금여부'] = '할부';
        //                         customerInfo['할부개월수'] = installmentConversionMatch[7] + '개월';
        //                         customerInfo['최종구매가'] = installmentConversionMatch[8].trim();
        //                     } else {
        //                         // 기존 할부 형식 패턴 (전환지원금 없는 경우)
        //                         const alternatePattern = /\*\*출고가\s+([\d,]+)\s*-\s*공시\s+([\d,]+)\s*-\s*추지\s+([\d,]+)(?:\s*-\s*프리할부\s+([\d,]+))?\s*=\s*할부(\d+)\s*([\d,]+)/;
        //                         const alternateMatch = text.match(alternatePattern);
                                
        //                         if (alternateMatch) {
        //                             customerInfo['출고가'] = alternateMatch[1].trim();
        //                             customerInfo['공시'] = alternateMatch[2].trim();
        //                             customerInfo['추지'] = alternateMatch[3].trim();
        //                             customerInfo['전환지원금'] = '0';
        //                             customerInfo['프리할부'] = alternateMatch[4] ? alternateMatch[4].trim() : '0';
        //                             customerInfo['할부현금여부'] = '할부';
        //                             customerInfo['할부개월수'] = alternateMatch[5] + '개월';
        //                             customerInfo['최종구매가'] = alternateMatch[6].trim();
        //                         } else {
        //                             customerInfo['출고가'] = '';
        //                             customerInfo['공시'] = '';
        //                             customerInfo['추지'] = '';
        //                             customerInfo['전환지원금'] = '0';
        //                             customerInfo['프리할부'] = '0';
        //                             customerInfo['할부현금여부'] = '';
        //                             customerInfo['할부개월수'] = '';
        //                             customerInfo['최종구매가'] = '';
        //                         }
        //                     }
        //                 }
        //             }
        //         }
        //     }
            
        //     // 모델명 변환 및 용량 정보 추출
        //     if (customerInfo['모델명']) {
        //         // 먼저 원본 모델명에서 용량 정보 추출 (convertModelName 실행 전)
        //         let capacityMatch = null;
        //         let hasUnit = false;
        //         let extractedCapacity = '';
        //         let originalModelName = customerInfo['모델명'];
                
        //         // 1. 단위가 있는 용량 먼저 찾기 (256G, 512GB, 1TB 등)
        //         capacityMatch = originalModelName.match(/(?:^|\s|_)(\d+)(?:\s*[GT]?[B]?)(?=\s|$|_)/i);
                
        //         let capacityFound = false;
                
        //         if (capacityMatch) {
        //             // 매칭된 결과에서 실제로 단위가 있는지 확인
        //             const matchedText = capacityMatch[0].replace(/^[\s_]+|[\s_]+$/g, '');
        //             const hasActualUnit = matchedText.match(/[GT]?[B]?$/i);
        //             // 실제로 G, GB, TB 등의 단위가 있는지 확인 (빈 문자열이 아닌 경우)
        //             const hasRealUnit = hasActualUnit && hasActualUnit[0] && hasActualUnit[0].length > 0;
                    
        //             if (hasRealUnit) {
        //                 // 실제로 단위가 있는 경우
        //                 hasUnit = true;
        //                 extractedCapacity = capacityMatch[1];
        //                 customerInfo['용량'] = matchedText;
        //                 // 원본 모델명에서 용량 부분 제거
        //                 originalModelName = originalModelName.replace(/(?:^|\s|_)\d+(?:\s*[GT]?[B]?)(?:\s|$|_)/i, ' ').replace(/\s+/g, ' ').trim();
        //                 capacityFound = true;
        //             }
        //         }
                
        //         if (!capacityFound) {
        //             // 2. 단위가 없는 용량 찾기 (256, 512 등)
        //             capacityMatch = originalModelName.match(/(?:^|\s|_)(\d+)(?:\s|$|_)/i);
                    
        //             if (capacityMatch) {
        //                 hasUnit = false;
        //                 extractedCapacity = capacityMatch[1];
        //                 customerInfo['용량'] = extractedCapacity + 'G';
        //                 // 원본 모델명에서 용량 부분 제거
        //                 originalModelName = originalModelName.replace(/(?:^|\s|_)\d+(?:\s|$|_)/i, ' ').replace(/\s+/g, ' ').trim();
        //                 capacityFound = true;
        //             } else {
        //                 // 3. 용량을 찾지 못한 경우
        //                 customerInfo['용량'] = '';
        //             }
        //         }
                
        //         // 용량이 제거된 모델명으로 변환 적용 (펫네임 → 실제 모델명)
        //         const convertedModelName = convertModelName(originalModelName);
        //         customerInfo['모델명'] = convertedModelName;
                
        //         // 모델제조사 자동 분류 (아이폰/갤럭시)
        //         if (convertedModelName.toLowerCase().includes('아이폰') || 
        //             convertedModelName.toLowerCase().includes('iphone')) {
        //             customerInfo['모델제조사'] = '아이폰';
        //         } else {
        //             customerInfo['모델제조사'] = '갤럭시';
        //         }
        //     } else {
        //         customerInfo['용량'] = '';
        //         customerInfo['모델제조사'] = '';
        //     }
            
        //     // 부가서비스와 보험 분리 처리 (개선된 버전)
        //     if (customerInfo['부가서비스']) {
        //         const originalAddon = customerInfo['부가서비스'];
        //         const parsed = parseAddonAndInsuranceEnhanced(customerInfo['부가서비스']);
                
        //         // 분리된 결과를 customerInfo에 저장
        //         customerInfo['보험'] = parsed.보험;
        //         customerInfo['부가서비스'] = parsed.부가서비스1;
        //         customerInfo['부가서비스2'] = parsed.부가서비스2;
                
        //         console.log('부가서비스 분리 결과:', {
        //             '원본': originalAddon,
        //             '분리된 보험': parsed.보험,
        //             '분리된 부가서비스1': parsed.부가서비스1,
        //             '분리된 부가서비스2': parsed.부가서비스2
        //         });
        //     } else {
        //         customerInfo['부가서비스2'] = '';
        //     }
            
        //     // 모델제조사에 따른 보험명 자동 설정 (모델제조사 설정 후 실행)
        //     if (customerInfo['보험'] && customerInfo['모델제조사']) {
        //         if (customerInfo['모델제조사'] === '갤럭시') {
        //             customerInfo['보험'] = 'T ALL케어플러스5 파손80(5300)';
        //             console.log('갤럭시 보험명 자동 설정: T ALL케어플러스5 파손80(5300)');
        //         } else if (customerInfo['모델제조사'] === '아이폰') {
        //             customerInfo['보험'] = 'T올케어+5 I파손';
        //             console.log('아이폰 보험명 자동 설정: T올케어+5 I파손');
        //         }
        //     }
            
        //     return customerInfo;
        // }

        // 양식 변환 함수
        function convertFormat() {
            // 출력 컨테이너 초기화
            const outputContainer = document.getElementById('outputContainer');
            const singleOutputContainer = document.getElementById('singleOutputContainer');
            const splitOutputContainer = document.getElementById('splitOutputContainer');
            const luxExtraOutputs = document.getElementById('luxExtraOutputs');
            const dblackExtraOutputs = document.getElementById('dblackExtraOutputs');
            const actExtraOutputs = document.getElementById('actExtraOutputs');
            const bncomExtraOutputs = document.getElementById('bncomExtraOutputs');
            const hunetExtraOutputs = document.getElementById('hunetExtraOutputs');
            const millionExtraOutputs = document.getElementById('millionExtraOutputs');
            const ontExtraOutputs = document.getElementById('ontExtraOutputs');
            const keyValueTableContainer = document.getElementById('keyValueTableContainer');
            
            // 모든 출력 컨테이너 숨기기
            if (splitOutputContainer) splitOutputContainer.style.display = 'none';
            if (luxExtraOutputs) luxExtraOutputs.style.display = 'none';
            if (dblackExtraOutputs) dblackExtraOutputs.style.display = 'none';
            if (actExtraOutputs) actExtraOutputs.style.display = 'none';
            if (bncomExtraOutputs) bncomExtraOutputs.style.display = 'none';
            if (hunetExtraOutputs) hunetExtraOutputs.style.display = 'none';
            if (millionExtraOutputs) millionExtraOutputs.style.display = 'none';
            if (ontExtraOutputs) ontExtraOutputs.style.display = 'none';
            const jangcheonExtraOutputs = document.getElementById('jangcheonExtraOutputs');
            if (jangcheonExtraOutputs) jangcheonExtraOutputs.style.display = 'none';
            if (keyValueTableContainer) keyValueTableContainer.style.display = 'none';
            
            // 기본 출력 컨테이너 표시
            if (singleOutputContainer) singleOutputContainer.style.display = 'block';
            
            // 모든 textarea 내용 초기화
            const allTextareas = outputContainer.getElementsByTagName('textarea');
            for (let textarea of allTextareas) {
                textarea.value = '';
            }
            
            // 모든 DOM 요소 참조 가져오기
            const agencySelect = document.getElementById('agency');
            const inputText = document.getElementById('inputText');
            const telecomSelect = document.getElementById('telecom');
            const deviceSerialInput = document.getElementById('deviceSerial');
            const simSerialInput = document.getElementById('simSerial');
            
            // 선택된 값 가져오기
            const selectedTelecom = telecomSelect ? telecomSelect.value : '';
            const selectedAgency = agencySelect ? agencySelect.value : '';
            
            // 입력값 검증
            if (!selectedTelecom || !selectedAgency) {
                alert('통신사와 대리점을 모두 선택해주세요.');
                return;
            }
            
            try {
                // 고객 정보 추출
                const customerInfo = extractCustomerInfo(inputText.value || '');
            
            // 단말기 일련번호와 유심 일련번호 추가
            if (deviceSerialInput && deviceSerialInput.value.trim()) {
                customerInfo['단말기일련번호'] = deviceSerialInput.value.trim();
            }
            if (simSerialInput && simSerialInput.value.trim()) {
                customerInfo['유심일련번호'] = simSerialInput.value.trim();
            }
            
                console.log('추출된 고객 정보:', customerInfo);
                console.table(customerInfo);
                
                // KT 대리점 약정 체크
                if (selectedTelecom === 'KT') {
                    const 공시선약여부 = customerInfo['공시선약여부'] || customerInfo['할인유형'] || '';
                    const 약정개월수 = customerInfo['약정개월수'] || '';
                    
                    if (공시선약여부 === '선택약정' && 약정개월수 === '12개월') {
                        alert('KT 대리점은 선택약정 24개월만 진행 가능합니다. 어드민 메모를 확인하세요.');
                    }
                }
                
                // 필수 항목 체크 및 alert 표시
                const requiredFields = ['가입유형', '할인유형', '유심', '요금제', '약정개월수', '최종구매가', '용량', '모델제조사', '현재통신사'];
                const emptyFields = [];
                
                requiredFields.forEach(field => {
                    if (!customerInfo[field] || customerInfo[field].trim() === '') {
                        emptyFields.push(field);
                    }
                });
                
                if (emptyFields.length > 0) {
                    const missingItems = emptyFields.join(', ');
                    alert(`다음 항목들이 비어있습니다: ${missingItems}\n 어드민 메모를 확인해보세요.`);
                }
                
                // 새로운 구조의 템플릿 시스템 사용 시도
                let result;
                let outputType;
                
                if (TELECOM_CONFIG[selectedTelecom]?.agencies[selectedAgency]) {
                    // 새로운 구조 사용
                    const agencyConfig = TELECOM_CONFIG[selectedTelecom].agencies[selectedAgency];
                    result = TemplateManager.applyTemplate(selectedTelecom, selectedAgency, customerInfo);
                    outputType = agencyConfig.outputType;
                    
                    // 결과 출력
                    OutputManager.showOutput(result, outputType, selectedTelecom, selectedAgency);
                } else {
                    // TELECOM_CONFIG에 없는 대리점은 오류 처리
                    throw new Error(`선택하신 대리점 (${selectedAgency})에 대한 템플릿을 찾을 수 없습니다. TELECOM_CONFIG에 추가가 필요합니다.`);
                }
                
                // 변환 이력 저장
                saveToHistory(customerInfo, selectedTelecom, selectedAgency);
                    
                    // 더블클릭 이벤트 설정
                    setupDoubleClickCopy();
                
            } catch (error) {
                console.error('변환 중 오류:', error);
                alert('변환 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 키-값 테이블 생성 함수
        function createKeyValueTable(customerInfo) {
            const tableBody = document.querySelector('#keyValueTable tbody');
            tableBody.innerHTML = ''; // 테이블 초기화
            
            // 현재 선택된 대리점 확인
            const agencySelect = document.getElementById('agency');
            const selectedAgency = agencySelect ? agencySelect.value : '';
            
            // 기본 정보 처리 (우선순위에 따라 값 선택)
            const processedInfo = {
                '가입자명': customerInfo['가입자명'] || customerInfo['고객명'] || '',
                '개통번호': customerInfo['개통번호'] || customerInfo['전화번호'] || '',
                '주민번호': customerInfo['주민번호'] || customerInfo['생년월일'] || '',
                '모델명': customerInfo['모델명'] || '',
                '용량': customerInfo['용량'] || '',
                '색상': customerInfo['색상'] || '',
                '가입유형': customerInfo['가입유형'] || '',
                '할인유형': customerInfo['할인유형'] || '',
                '약정개월수': customerInfo['약정개월수'] || '',
                '요금제': customerInfo['요금제'] || '',
                '할부현금여부': customerInfo['할부현금여부'] || '',
                '할부개월수': customerInfo['할부개월수'] || '',
                '현재통신사': customerInfo['현재통신사'] || '',
                '단말기일련번호': customerInfo['단말기일련번호'] || '',
                '유심': customerInfo['유심'] || '',
                '유심일련번호': customerInfo['유심일련번호'] || '',
                '출고가': customerInfo['출고가'] || '',
                '공시지원금': customerInfo['공시'] || '',
                '추가지원금': customerInfo['추지'] || '',
                '전환지원금': customerInfo['전환지원금'] || '',
                '프리할부': customerInfo['프리할부'] || '',
                '최종구매가': customerInfo['최종구매가'] || '',
                '부가서비스': customerInfo['부가서비스'] || '',
                '부가서비스2': customerInfo['부가서비스2'] || '',
                '보험': customerInfo['보험'] || '',
                '배송주소지': customerInfo['배송주소지'] || customerInfo['택배주소'] || '',
                '미성년자여부': customerInfo['미성년자여부'] || '',
                '법정대리인이름': customerInfo['법정대리인이름'] || customerInfo['법정대리인명'] || '',
                '법정대리인연락처': customerInfo['법정대리인연락처'] || '',
                '법정대리인주민번호': customerInfo['법정대리인주민번호'] || ''
            };
            
            // 테이블에 표시할 필드 순서 정의
            const basicFields = [
                '가입자명', '개통번호', '주민번호', '모델명', '용량', '색상',
                '가입유형', '할인유형', '약정개월수', '요금제', 
                '할부현금여부', '할부개월수', '현재통신사'
            ];
            
            const deviceFields = [
                '단말기일련번호', '유심', '유심일련번호'
            ];
            
            const priceFields = [
                '출고가', '공시지원금', '추가지원금', '전환지원금', 
                '프리할부', '최종구매가'
            ];
            
            const additionalFields = [
                '부가서비스', '부가서비스2', '보험', '배송주소지'
            ];
            
            const minorFields = [
                '미성년자여부', '법정대리인이름', '법정대리인연락처', '법정대리인주민번호'
            ];
            
            // 기본 정보 필드 추가
            basicFields.forEach(fieldName => {
                const value = processedInfo[fieldName];
                if (value !== undefined && value !== null && value !== '') {
                    addTableRow(tableBody, fieldName, value);
                }
            });
            
            // 단말기 정보 필드 추가
            deviceFields.forEach(fieldName => {
                const value = processedInfo[fieldName];
                if (value !== undefined && value !== null && value !== '') {
                    addTableRow(tableBody, fieldName, value);
                }
            });
            
            // 가격 정보 필드 추가 (빈 값이어도 표시)
            priceFields.forEach(fieldName => {
                const value = processedInfo[fieldName];
                addTableRow(tableBody, fieldName, value || '');
            });
            
            // 추가 정보 필드 추가
            additionalFields.forEach(fieldName => {
                const value = processedInfo[fieldName];
                if (value !== undefined && value !== null && value !== '') {
                    addTableRow(tableBody, fieldName, value);
                }
            });
            
            // 미성년자인 경우 법정대리인 정보 추가
            if (processedInfo['미성년자여부'] === 'Y') {
                minorFields.forEach(fieldName => {
                    const value = processedInfo[fieldName];
                    if (value !== undefined && value !== null && value !== '') {
                        addTableRow(tableBody, fieldName, value);
                    }
                });
            }
            
            // 추가 테이블 안내문 표시
            const copyNoticeDiv = document.querySelector('.copy-notice');
            if (copyNoticeDiv) {
                copyNoticeDiv.textContent = `${selectedAgency} - 각 항목을 클릭하면 해당 값이 클립보드에 복사됩니다.`;
            }
        }
        
        // 키-값 테이블에 행 추가하는 함수
        function addTableRow(tableBody, key, value) {
            const row = document.createElement('tr');
            
            const keyCell = document.createElement('td');
            keyCell.className = 'key-cell';
            keyCell.textContent = key;
            
            const valueCell = document.createElement('td');
            valueCell.className = 'value-cell';
            valueCell.textContent = value;
            valueCell.setAttribute('data-value', value);
            valueCell.onclick = function() {
                copyToClipboardWithFeedback(this.getAttribute('data-value'), this);
            };
            
            row.appendChild(keyCell);
            row.appendChild(valueCell);
            tableBody.appendChild(row);
        }
        
        
        
        // 변환 이력 저장
        function saveToHistory(customerInfo, telecom, agency) {
            try {
                let history = JSON.parse(localStorage.getItem('conversionHistory') || '[]');
                
                // 원본 텍스트가 없으면 저장하지 않음 (불필요한 데이터 방지)
                const inputText = document.getElementById('inputText');
                if (inputText && inputText.value.trim()) {
                    customerInfo.원본텍스트 = inputText.value.trim();
                } else {
                    return; // 원본 텍스트가 없으면 저장하지 않음
                }
                
                // 중복 체크 (동일한 고객명과 전화번호가 있는지)
                const exists = history.some(item => {
                    const sameName = String(item.customerInfo.고객명 || '') === String(customerInfo.고객명 || '');
                    const samePhone = String(item.customerInfo.전화번호 || '') === String(customerInfo.전화번호 || '');
                    const sameAgency = String(item.agency || '') === String(agency || '');
                    
                    // 고객명과 전화번호가 모두 일치하고, 동일한 대리점인 경우에만 중복으로 판단
                    return sameName && samePhone && sameAgency;
                });
                
                if (!exists) {
                    // 최대 50개까지 저장
                    if (history.length >= 50) {
                        history.pop(); // 가장 오래된 항목 제거
                    }
                    
                    // 새 항목 추가 (최신순으로 정렬하기 위해 unshift 사용)
                    history.unshift({
                        id: Date.now(),
                        customerInfo: customerInfo,
                        telecom: telecom,
                        agency: agency,
                        timestamp: new Date().toISOString()
                    });
                    
                    localStorage.setItem('conversionHistory', JSON.stringify(history));
                }
            } catch (e) {
                console.error('이력 저장 중 오류 발생:', e);
            }
        }
        
        // 변환 이력 불러오기
        function loadHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('conversionHistory') || '[]');
                const historyList = document.getElementById('historyList');
                
                if (!historyList) return;
                
                if (history.length === 0) {
                    historyList.innerHTML = '<div class="no-history">저장된 이력이 없습니다.</div>';
                    return;
                }
                
                historyList.innerHTML = history.map(item => `
                    <div class="history-item" onclick="loadFromHistory('${item.id}')">
                        <div class="history-header">
                            <span class="history-name">${item.customerInfo.고객명 || '이름 없음'}</span>
                            <span class="history-phone">${item.customerInfo.전화번호 || item.customerInfo.연락처 || '전화번호 없음'}</span>
                            <span class="history-time">${new Date(item.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="history-details">
                            <span class="history-model">${item.customerInfo.모델명 || ''} ${item.customerInfo.색상 || ''}</span>
                            <span class="history-plan">${item.customerInfo.요금제 || ''}</span>
                        </div>
                        <div class="history-footer">
                            <span class="history-agency">${item.telecom} / ${item.agency}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('이력 불러오기 중 오류 발생:', e);
            }
        }
        
        // 이력에서 불러오기
        function loadFromHistory(id) {
            try {
                const history = JSON.parse(localStorage.getItem('conversionHistory') || '[]');
                const item = history.find(item => item.id.toString() === id.toString());
                
                if (item) {
                    // 통신사와 대리점 선택
                    const telecomSelect = document.getElementById('telecom');
                    const agencySelect = document.getElementById('agency');
                    
                    // 현재 선택된 값 저장
                    const currentTelecom = telecomSelect.value;
                    const currentAgency = agencySelect.value;
                    
                    // 새 값으로 설정
                    telecomSelect.value = item.telecom;
                    
                    // 대리점이 로드될 때까지 기다렸다가 선택
                    const checkAgency = setInterval(() => {
                        updateAgencies();
                        
                        // 대리점이 로드되었는지 확인 (옵션 목록에 있는지)
                        const agencyOptions = Array.from(agencySelect.options).map(opt => opt.value);
                        if (agencyOptions.includes(item.agency)) {
                            clearInterval(checkAgency);
                            
                            // 대리점 선택
                            agencySelect.value = item.agency;
                            
                            // 입력 필드 채우기
                            const info = item.customerInfo;
                            const inputText = document.getElementById('inputText');
                            const deviceSerial = document.getElementById('deviceSerial');
                            const simSerial = document.getElementById('simSerial');
                            
                            // 원본 텍스트가 없으면 기본 텍스트 생성
                            if (!info.원본텍스트) {
                                let defaultText = '';
                                if (info.고객명) defaultText += `고객명: ${info.고객명}\n`;
                                if (info.전화번호) defaultText += `전화번호: ${info.전화번호}\n`;
                                if (info.모델명) defaultText += `모델명: ${info.모델명}\n`;
                                if (info.색상) defaultText += `색상: ${info.색상}\n`;
                                if (info.요금제) defaultText += `요금제: ${info.요금제}\n`;
                                if (info.가입유형) defaultText += `가입유형: ${info.가입유형}\n`;
                                if (info.할부현금여부) defaultText += `할부/현금: ${info.할부현금여부}\n`;
                                if (info.최종구매가) defaultText += `최종구매가: ${info.최종구매가}원\n`;
                                
                                inputText.value = defaultText.trim();
                            } else {
                                inputText.value = info.원본텍스트 || '';
                            }
                            
                            if (deviceSerial) deviceSerial.value = info.단말기일련번호 || '';
                            if (simSerial) simSerial.value = info.유심일련번호 || '';
                            
                            // 변환 실행 (약간의 지연을 두어 UI 업데이트가 완료되도록)
                            setTimeout(() => {
                                convertFormat();
                                closeHistoryPopup();
                            }, 300);
                        }
                    }, 50);
                }
            } catch (e) {
                console.error('이력 불러오기 중 오류 발생:', e);
                alert('이력 불러오기에 실패했습니다.');
            }
        }
        
        // 이력 팝업 열기
        function openHistoryPopup() {
            const popup = document.getElementById('historyPopup');
            if (popup) {
                loadHistory();
                popup.style.display = 'flex';
            }
        }
        
        // 이력 팝업 닫기
        function closeHistoryPopup() {
            const popup = document.getElementById('historyPopup');
            if (popup) {
                popup.style.display = 'none';
            }
        }
        
        // 이력 전체 삭제
        function clearHistory() {
            if (confirm('모든 변환 이력을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                localStorage.removeItem('conversionHistory');
                loadHistory();
            }
        }
        
        // 모두 지우기 함수
        function clearAll() {
            // 입력 필드 초기화
            document.getElementById('inputText').value = '';
            document.getElementById('deviceSerial').value = '';
            document.getElementById('simSerial').value = '';
            
            // 엑셀 파일 입력 초기화 (excel-manager.js와 연동)
            if (typeof clearExcelInputs === 'function') {
                clearExcelInputs();
            } else {
                // fallback: 직접 초기화
                document.getElementById('excelFile').value = '';
                document.getElementById('extractCount').textContent = '';
                
                const excelFile2 = document.getElementById('excelFile2');
                if (excelFile2) excelFile2.value = '';
                
                const extractCount2Element = document.getElementById('extractCount2');
                if (extractCount2Element) {
                    extractCount2Element.textContent = '';
                }
                
                const downloadBtn = document.getElementById('downloadDeliveryBtn');
                if (downloadBtn) {
                    downloadBtn.style.display = 'none';
                    downloadBtn.removeAttribute('data-telecom');
                    downloadBtn.removeAttribute('data-agency');
                    downloadBtn.removeAttribute('data-count');
                }
            }
            
            // 통신사 및 대리점 선택 초기화
            const telecomSelect = document.getElementById('telecom');
            const agencySelect = document.getElementById('agency');
            const currentTelecom = telecomSelect.value;
            const currentAgency = agencySelect.value;
            
            // 출력 컨테이너 초기화 (기존 구조 유지)
            const outputContainer = document.getElementById('outputContainer');
            outputContainer.style.display = 'block';
            
            // Reset to the original structure with proper agency labels for both 럭스 and 드블랙
            outputContainer.innerHTML = `
                <!-- 럭스 전용 추가 textarea (신조/재고/개통) -->
                <div id="luxExtraOutputs" style="display:none;">
                    <div class="form-group">
                        <label for="luxRequestText">신조요청양식:</label>
                        <textarea id="luxRequestText" class="output-textarea compact-textarea" placeholder="신조 요청 양식이 여기에 표시됩니다."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="luxStockText">재고요청양식:</label>
                        <textarea id="luxStockText" class="output-textarea compact-textarea" placeholder="재고 요청 양식이 여기에 표시됩니다."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="luxMemoText">개통요청양식:</label>
                        <textarea id="luxMemoText" class="output-textarea compact-textarea" placeholder="개통 요청 양식이 여기에 표시됩니다."></textarea>
                    </div>
                </div>
                
                <!-- 드블랙 전용 추가 textarea (신조/재고/개통) -->
                <div id="dblackExtraOutputs" style="display:none;">
                    <div class="form-group">
                        <label for="dblackRequestText">신조요청양식:</label>
                        <textarea id="dblackRequestText" class="output-textarea compact-textarea" placeholder="신조 요청 양식이 여기에 표시됩니다."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="dblackStockText">재고요청양식:</label>
                        <textarea id="dblackStockText" class="output-textarea compact-textarea" placeholder="재고 요청 양식이 여기에 표시됩니다."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="dblackMemoText">개통요청양식:</label>
                        <textarea id="dblackMemoText" class="output-textarea compact-textarea" placeholder="개통 요청 양식이 여기에 표시됩니다."></textarea>
                    </div>
                </div>
                <style>
                    /* 럭스 텍스트에리어 스타일 */
                    #luxRequestText, #dblackRequestText {
                        height: 130px !important;
                        min-height: 130px;
                        resize: vertical;
                    }
                    #luxStockText, #dblackStockText {
                        height: 220px !important;
                        min-height: 220px;
                        resize: vertical;
                    }
                    #luxMemoText, #dblackMemoText {
                        height: 150px !important;
                        min-height: 150px;
                        resize: vertical;
                    }
                    #outputText1 {
                        height: 170px !important;
                        min-height: 170px;
                    }
                </style>
                <div id="singleOutputContainer">
                    <div class="form-group">
                        <label id="outputTextLabel" for="outputText">변환된 텍스트:</label>
                        <textarea id="outputText" class="output-textarea" placeholder="여기에 변환된 결과가 표시됩니다. 더블클릭하면 복사됩니다."></textarea>
                    </div>
                </div>
                <div id="splitOutputContainer" style="display: none;"></div>
            `;
            
            // Reset telecom and agency selects after updating the output container
            telecomSelect.value = '';
            agencySelect.innerHTML = '<option value="">대리점을 선택하세요</option>';
            agencySelect.disabled = true;
            
            // 더블클릭 이벤트 설정
            setupDoubleClickCopy();
            
            // 입력 필드에 포커스
            document.getElementById('inputText').focus();
            
            // If the current selection was 럭스 or 드블랙, re-enable the agency select
            if (currentTelecom === 'SK' && (currentAgency === '럭스' || currentAgency === '드블랙')) {
                updateAgencies();
                document.getElementById('agency').value = currentAgency;
            }
        }
        // 대리점 정보 팝업 함수
        function showAgencyInfo() {
            const telecomSelect = document.getElementById('telecom');
            const agencySelect = document.getElementById('agency');
            const selectedTelecom = telecomSelect.value;
            const selectedAgency = agencySelect.value;
            
            if (!selectedTelecom || !selectedAgency) {
                alert('통신사와 대리점을 모두 선택해주세요.');
                return;
            }
            
            const popup = document.getElementById('memoPopup');
            const popupTitle = document.getElementById('popupTitle');
            const popupContent = document.getElementById('memoContent');
            
            // 팝업 제목 설정
            popupTitle.textContent = `${selectedAgency} 업무 메모`;
            
            // 팝업 내용 설정
            if (agencyMemos[selectedTelecom] && agencyMemos[selectedTelecom][selectedAgency]) {
                popupContent.textContent = agencyMemos[selectedTelecom][selectedAgency];
            } else {
                popupContent.textContent = '해당 대리점에 대한 업무 메모가 없습니다.';
            }
            
            // 팝업 표시
            popup.style.display = 'flex';
        }
        
        // 대리점 정보 팝업 닫기 함수
        function closeAgencyInfo() {
            const popup = document.getElementById('memoPopup');
            popup.style.display = 'none';
        }
        // ESC 키로 팝업 닫기
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAgencyInfo();
                closeHistoryPopup();
            }
        });
        
        // 팝업 외부 클릭 시 닫기
        document.getElementById('memoPopup').addEventListener('click', function(event) {
            if (event.target === this) {
                closeAgencyInfo();
            }
        });     

        // utils.js에서 제공하는 함수들을 사용하여 모델 데이터베이스 초기화
        if (typeof initializeModelDatabase === 'function') {
            initializeModelDatabase();
        }
        
        // 페이지 로드 완료 후 자동 잠금 기능 초기화
        window.addEventListener('load', function() {
            // 메인 콘텐츠가 표시된 상태일 때만 자동 잠금 시작
            const mainContent = document.querySelector('.main-content');
            const passwordModal = document.getElementById('passwordModal');
            
            if (mainContent && mainContent.style.display !== 'none' && 
                passwordModal && passwordModal.style.display === 'none') {
                // 자동 잠금 매니저 시작
                autoLockManager = new AutoLockManager();
                console.log(`자동 잠금 기능이 시작되었습니다. (${AUTO_LOCK_TIMEOUT_MINUTES}분 후 자동 잠금)`);
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // 초기 텍스트에리어에 더블클릭 이벤트 설정
            setupDoubleClickCopy();
            
            // 모델 검색 이벤트 리스너 추가
            const searchInput = document.getElementById('modelSearch');
            const searchResults = document.getElementById('modelSearchResults');
            
            if (searchInput) {
                // 입력 이벤트
                searchInput.addEventListener('input', (e) => {
                    const results = searchDeviceModel(e.target.value);
                    displayDeviceSearchResults(results);
                });
                
                // 포커스 아웃 시 약간의 지연 후 결과창 숨기기
                searchInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        searchResults.style.display = 'none';
                    }, 200);
                });
                
                // 외부 클릭 시 결과창 숨기기
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                        searchResults.style.display = 'none';
                    }
                });
            }
            
            // 초기화 메시지 추가
            const outputText = document.getElementById('outputText');
            if (outputText) {
                outputText.placeholder = '여기에 변환된 결과가 표시됩니다. 더블클릭하면 복사됩니다.';
                // 클래스 추가
                outputText.classList.add('output-textarea');
            }
            
            // 입력 텍스트에리어에 클래스 추가
            const inputText = document.getElementById('inputText');
            if (inputText) {
                inputText.classList.add('input-textarea');
            }
        });

        function setupEventListeners() {
            document.getElementById('convertBtn').addEventListener('click', handleConvert);
            document.getElementById('copyBtn').addEventListener('click', handleCopy);
            document.getElementById('clearBtn').addEventListener('click', handleClear);
            
            // 이벤트 위임 사용
            document.getElementById('outputContainer').addEventListener('dblclick', handleDoubleClick);
        }
        // 이벤트 관리 클래스
        class EventManager {
            static init() {
                this.setupTelecomEvents();
                this.setupAgencyEvents();
                this.setupConversionEvents();
                this.setupCopyEvents();
            }

            static setupTelecomEvents() {
                const telecomSelect = document.getElementById('telecom');
                if (telecomSelect) {
                    telecomSelect.addEventListener('change', () => {
                        updateAgencies();
                        this.clearOutputs();
                    });
                }
            }

            static setupAgencyEvents() {
                const agencySelect = document.getElementById('agency');
                if (agencySelect) {
                    agencySelect.addEventListener('change', () => {
                        const agencyInfoBtn = document.getElementById('agencyInfoBtn');
                        if (agencyInfoBtn) {
                            agencyInfoBtn.disabled = !agencySelect.value;
                        }
                        this.clearOutputs();
                    });
                }
            }

            static setupConversionEvents() {
                const convertBtn = document.getElementById('convertBtn');
                if (convertBtn) {
                    convertBtn.addEventListener('click', () => {
                        convertFormat();
                    });
                }
            }

            static setupCopyEvents() {
                const copyBtn = document.getElementById('copyBtn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        handleCopy();
                    });
                }
            }

            static clearOutputs() {
                OutputManager.hideAllContainers();
            }
        }



        // 자동 잠금 기능 클래스
        class AutoLockManager {
            constructor(timeoutMinutes = AUTO_LOCK_TIMEOUT_MINUTES) { // 상수 사용
                this.timeoutDuration = timeoutMinutes * 60 * 1000; // 밀리초로 변환
                this.timeoutId = null;
                this.isLocked = false;
                this.lastActivityTime = Date.now();
                
                // 활동 감지 이벤트들
                this.activityEvents = [
                    'mousedown', 'mousemove', 'keypress', 'scroll', 
                    'touchstart', 'click', 'keydown', 'input', 'change'
                ];
                
                this.init();
            }
            
            init() {
                console.log(`자동 잠금 기능 초기화: ${this.timeoutDuration / 60000}분 후 자동 잠금`);
                this.setupActivityListeners();
                this.startTimer();
            }
            
            setupActivityListeners() {
                // 모든 활동 이벤트에 대해 리스너 등록
                this.activityEvents.forEach(event => {
                    document.addEventListener(event, () => {
                        this.resetTimer();
                    }, true);
                });
                
                // 창 포커스 이벤트도 추가
                window.addEventListener('focus', () => {
                    this.resetTimer();
                });
            }
            
            startTimer() {
                this.clearTimer();
                this.timeoutId = setTimeout(() => {
                    this.lockApplication();
                }, this.timeoutDuration);
                
                this.lastActivityTime = Date.now();
            }
            
            resetTimer() {
                if (!this.isLocked) {
                    this.startTimer();
                }
            }
            
            clearTimer() {
                if (this.timeoutId) {
                    clearTimeout(this.timeoutId);
                    this.timeoutId = null;
                }
            }
            
            lockApplication() {
                console.log('자동 잠금 활성화: 일정 시간 동안 활동이 없어 잠금 처리됩니다.');
                this.isLocked = true;
                this.clearTimer();
                
                // 메인 콘텐츠 숨기기
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.style.display = 'none';
                }
                
                // 비밀번호 모달 표시
                const passwordModal = document.getElementById('passwordModal');
                if (passwordModal) {
                    passwordModal.style.display = 'flex';
                    
                    // 비밀번호 입력 필드 초기화 및 포커스
                    const passwordInput = document.getElementById('passwordInput');
                    if (passwordInput) {
                        passwordInput.value = '';
                        passwordInput.focus();
                    }
                    
                    // 에러 메시지 숨기기
                    const passwordError = document.getElementById('passwordError');
                    if (passwordError) {
                        passwordError.style.display = 'none';
                    }
                }
                
                // 잠금 알림 메시지 표시 (선택사항)
                this.showLockNotification();
            }
            
            unlockApplication() {
                console.log('자동 잠금 해제: 정상적으로 잠금이 해제되었습니다.');
                this.isLocked = false;
                this.startTimer(); // 타이머 재시작
            }
            
            showLockNotification() {
                // 임시 알림 div 생성
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f44336;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    font-size: 14px;
                    font-weight: bold;
                `;
                notification.textContent = '보안을 위해 자동으로 잠금되었습니다.';
                
                document.body.appendChild(notification);
                
                // 3초 후 알림 제거
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
            
            // 타임아웃 시간 변경 메서드
            setTimeoutDuration(minutes) {
                this.timeoutDuration = minutes * 60 * 1000;
                console.log(`자동 잠금 시간이 ${minutes}분으로 변경되었습니다.`);
                if (!this.isLocked) {
                    this.startTimer(); // 새로운 시간으로 타이머 재시작
                }
            }
            
            // 남은 시간 확인 메서드 (디버깅용)
            getRemainingTime() {
                if (this.isLocked) return 0;
                const elapsed = Date.now() - this.lastActivityTime;
                const remaining = Math.max(0, this.timeoutDuration - elapsed);
                return Math.ceil(remaining / 1000); // 초 단위로 반환
            }
        }
        
        // 전역 자동 잠금 인스턴스 생성 (페이지 로드 후)
        let autoLockManager = null;
        
        // 자동 잠금 시간 설정 함수 (콘솔에서 사용)
        function setAutoLockTime(minutes) {
            if (autoLockManager) {
                autoLockManager.setTimeoutDuration(minutes);
                return `자동 잠금 시간이 ${minutes}분으로 설정되었습니다.`;
            } else {
                return '자동 잠금 매니저가 초기화되지 않았습니다.';
            }
        }
        
        // 자동 잠금 상태 확인 함수 (콘솔에서 사용)
        function getAutoLockStatus() {
            if (autoLockManager) {
                const remaining = autoLockManager.getRemainingTime();
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                return {
                    isLocked: autoLockManager.isLocked,
                    remainingTime: `${minutes}분 ${seconds}초`,
                    remainingSeconds: remaining
                };
            } else {
                return '자동 잠금 매니저가 초기화되지 않았습니다.';
            }
        }
        
        // 전역 함수로 노출
        window.setAutoLockTime = setAutoLockTime;
        window.getAutoLockStatus = getAutoLockStatus;
        
    </script>
    </div> <!-- main-content 닫는 태그 -->
</body>
</html>
